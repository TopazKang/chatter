# ============================================
# 회사 주차 관리 서비스 - Docker Compose 설정
# ============================================
# 프로덕션 레벨 컨테이너 오케스트레이션 설정
#
# 목적:
# - 턴키 방식 배포 (docker-compose up -d 한 번으로 전체 스택 실행)
# - 리소스 제한으로 안정적인 운영 보장
# - 헬스체크 및 자동 재시작으로 고가용성 확보
# - 보안 강화 (read-only 파일시스템, 권한 제한)
#
# 실행 방법:
# 1. .env 파일 생성: cp .env.example .env
# 2. 환경 변수 설정 (필요 시)
# 3. 실행: docker-compose up -d
# 4. 상태 확인: docker-compose ps
# 5. 로그 확인: docker-compose logs -f
# 6. 중지: docker-compose down

version: '3.8'

services:
  # ============================================
  # PostgreSQL Database
  # ============================================
  database:
    image: postgres:15-alpine
    container_name: parking-database

    # 환경 변수 설정
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-parkingadmin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-securepassword}
      POSTGRES_DB: ${POSTGRES_DB:-parking_management}
      # PostgreSQL 성능 튜닝
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
      POSTGRES_HOST_AUTH_METHOD: ${POSTGRES_HOST_AUTH_METHOD:-scram-sha-256}

    # 볼륨 마운트
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/01_init.sql:ro
      - ./database/migrations:/docker-entrypoint-initdb.d/migrations:ro
      # 백업 디렉토리 (선택)
      - ./backups:/backups

    # 포트 매핑 (개발 환경에서만 노출, 프로덕션에서는 주석 처리 권장)
    ports:
      - "${POSTGRES_PORT:-5432}:5432"

    # 헬스체크 설정
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-parkingadmin} -d ${POSTGRES_DB:-parking_management}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    # 리소스 제한 (메모리 부족 방지)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

    # 재시작 정책
    restart: unless-stopped

    # 보안 설정
    security_opt:
      - no-new-privileges:true

    # 로깅 설정
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    networks:
      - parking-network

  # ============================================
  # Backend API Server (Node.js + Express)
  # ============================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      # 빌드 캐시 활용
      cache_from:
        - parking-backend:latest

    image: parking-backend:latest
    container_name: parking-backend

    # 환경 변수 설정
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      DATABASE_HOST: database
      DATABASE_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-parkingadmin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-securepassword}
      POSTGRES_DB: ${POSTGRES_DB:-parking_management}
      BACKEND_PORT: ${BACKEND_PORT:-3000}
      API_PREFIX: ${API_PREFIX:-/api}
      # 로깅 레벨
      LOG_LEVEL: ${LOG_LEVEL:-info}
      # CORS 설정
      CORS_ORIGIN: ${CORS_ORIGIN:-*}

    # 포트 매핑 (Nginx를 통한 접근 권장)
    ports:
      - "${BACKEND_PORT:-3000}:3000"

    # 의존성 설정 (데이터베이스가 healthy 상태일 때만 시작)
    depends_on:
      database:
        condition: service_healthy

    # 볼륨 마운트 (개발 환경용, 프로덕션에서는 제거 권장)
    # volumes:
    #   - ./backend/src:/app/src:ro
    #   - backend_logs:/app/logs

    # 헬스체크 설정
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # 리소스 제한
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
      # 자동 스케일링 (Swarm 모드에서 사용)
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 10s

    # 재시작 정책
    restart: unless-stopped

    # 보안 설정
    security_opt:
      - no-new-privileges:true
    # read_only: true  # 읽기 전용 파일시스템 (로그 디렉토리 필요 시 tmpfs 사용)

    # 로깅 설정
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=backend"

    networks:
      - parking-network

  # ============================================
  # Frontend Web Application (React + Nginx)
  # ============================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${VITE_API_URL:-http://localhost:3000/api}
      # 빌드 캐시 활용
      cache_from:
        - parking-frontend:latest

    image: parking-frontend:latest
    container_name: parking-frontend

    # 포트 매핑 (HTTP)
    ports:
      - "${FRONTEND_PORT:-80}:80"
      # HTTPS를 위한 443 포트 (SSL 인증서 설정 필요)
      # - "443:443"

    # 의존성 설정
    depends_on:
      backend:
        condition: service_healthy

    # 헬스체크 설정
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # 리소스 제한
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M
      replicas: 1

    # 재시작 정책
    restart: unless-stopped

    # 보안 설정
    security_opt:
      - no-new-privileges:true
    read_only: true  # Nginx는 읽기 전용으로 안전하게 실행 가능

    # tmpfs 마운트 (읽기 전용 파일시스템에서 쓰기 가능 영역)
    tmpfs:
      - /var/cache/nginx:uid=101,gid=101
      - /var/run:uid=101,gid=101
      - /tmp

    # 로깅 설정
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=frontend"

    networks:
      - parking-network

# ============================================
# 볼륨 정의
# ============================================
volumes:
  # PostgreSQL 데이터 볼륨
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${POSTGRES_DATA_PATH:-./data/postgres}

  # 백엔드 로그 볼륨 (선택)
  # backend_logs:
  #   driver: local

# ============================================
# 네트워크 정의
# ============================================
networks:
  parking-network:
    driver: bridge
    # 서브넷 지정 (선택)
    ipam:
      config:
        - subnet: 172.20.0.0/16
    # 네트워크 격리 강화
    driver_opts:
      com.docker.network.bridge.name: parking-br0
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.enable_ip_masquerade: "true"
